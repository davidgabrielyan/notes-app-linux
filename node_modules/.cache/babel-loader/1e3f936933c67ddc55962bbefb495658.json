{"ast":null,"code":"'use strict';\n\nconst Packets = require('../packets/index.js');\n\nconst Command = require('./command.js');\n\nconst CloseStatement = require('./close_statement.js');\n\nconst Execute = require('./execute.js');\n\nclass PreparedStatementInfo {\n  constructor(query, id, columns, parameters, connection) {\n    this.query = query;\n    this.id = id;\n    this.columns = columns;\n    this.parameters = parameters;\n    this.rowParser = null;\n    this._connection = connection;\n  }\n\n  close() {\n    return this._connection.addCommand(new CloseStatement(this.id));\n  }\n\n  execute(parameters, callback) {\n    if (typeof parameters === 'function') {\n      callback = parameters;\n      parameters = [];\n    }\n\n    return this._connection.addCommand(new Execute({\n      statement: this,\n      values: parameters\n    }, callback));\n  }\n\n}\n\nclass Prepare extends Command {\n  constructor(options, callback) {\n    super();\n    this.query = options.sql;\n    this.onResult = callback;\n    this.id = 0;\n    this.fieldCount = 0;\n    this.parameterCount = 0;\n    this.fields = [];\n    this.parameterDefinitions = [];\n    this.options = options;\n  }\n\n  start(packet, connection) {\n    const Connection = connection.constructor;\n    this.key = Connection.statementKey(this.options);\n\n    const statement = connection._statements.get(this.key);\n\n    if (statement) {\n      if (this.onResult) {\n        this.onResult(null, statement);\n      }\n\n      return null;\n    }\n\n    const cmdPacket = new Packets.PrepareStatement(this.query, connection.config.charsetNumber);\n    connection.writePacket(cmdPacket.toPacket(1));\n    return Prepare.prototype.prepareHeader;\n  }\n\n  prepareHeader(packet, connection) {\n    const header = new Packets.PreparedStatementHeader(packet);\n    this.id = header.id;\n    this.fieldCount = header.fieldCount;\n    this.parameterCount = header.parameterCount;\n\n    if (this.parameterCount > 0) {\n      return Prepare.prototype.readParameter;\n    }\n\n    if (this.fieldCount > 0) {\n      return Prepare.prototype.readField;\n    }\n\n    return this.prepareDone(connection);\n  }\n\n  readParameter(packet, connection) {\n    const def = new Packets.ColumnDefinition(packet, connection.clientEncoding);\n    this.parameterDefinitions.push(def);\n\n    if (this.parameterDefinitions.length === this.parameterCount) {\n      return Prepare.prototype.parametersEOF;\n    }\n\n    return this.readParameter;\n  }\n\n  readField(packet, connection) {\n    const def = new Packets.ColumnDefinition(packet, connection.clientEncoding);\n    this.fields.push(def);\n\n    if (this.fields.length === this.fieldCount) {\n      return Prepare.prototype.fieldsEOF;\n    }\n\n    return Prepare.prototype.readField;\n  }\n\n  parametersEOF(packet, connection) {\n    if (!packet.isEOF()) {\n      return connection.protocolError('Expected EOF packet after parameters');\n    }\n\n    if (this.fieldCount > 0) {\n      return Prepare.prototype.readField;\n    }\n\n    return this.prepareDone(connection);\n  }\n\n  fieldsEOF(packet, connection) {\n    if (!packet.isEOF()) {\n      return connection.protocolError('Expected EOF packet after fields');\n    }\n\n    return this.prepareDone(connection);\n  }\n\n  prepareDone(connection) {\n    const statement = new PreparedStatementInfo(this.query, this.id, this.fields, this.parameterDefinitions, connection);\n\n    connection._statements.set(this.key, statement);\n\n    if (this.onResult) {\n      this.onResult(null, statement);\n    }\n\n    return null;\n  }\n\n}\n\nmodule.exports = Prepare;","map":null,"metadata":{},"sourceType":"script"}